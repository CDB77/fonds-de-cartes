<head>
<meta charset="UTF-8">
    <script src="./lib/d3.v3.min.js"></script>
    <script src="./lib/queue.v1.min.js"></script>

<style>
svg #borders .border { stroke: white !important }
</style>
</head>


<script>
function choropleth(e, opts) {

	var svg = d3.select(
		e
		.getSVGDocument()
		.getElementsByTagName("svg")[0]
	);

	var sign = opts.order === 'desc' ? -1 : 1;


	var what = '.' + (opts.what || 'country');
	var range = opts.range ? opts.range : ['#cc2f2f', 'yellow'];

	if (opts.titre) {
		var titre = (typeof opts.titre === 'object')
			? opts.titre
			: [ opts.titre ];

		svg
			.selectAll('#title text')
			.data(titre)
			.text(function(d) { return d; })
			.exit()
			.remove();
	}

	queue()
	.defer(d3.csv, opts.csv)
	.defer(d3.json, '../some-geo-data/population-centroids.geojson')
	.await(function(err, data, pop) {

		var pops = d3.map(), total_pop = 0;
		pop.features.forEach(function(d) {
			var p = parseInt(d.properties['POP_EST']);
			pops.set(d.properties['ISO_A3'], p);
			total_pop += p;
		});
		function accessor(d) {
			var iso = d.iso3, sum = 0, arrival = 0, cool = [];
			data.forEach(function(e) {
				if (parseInt(e[iso]) >= opts.threshold) {
					sum += (parseInt(pops.get(e['iso3']))||0);
					cool.push(e['iso3']);
				}
				if (parseInt(e[iso]) == 3) {
					arrival += (parseInt(pops.get(e['iso3']))||0);
				}
			});

console.log(iso, sum, cool);

			return [sum, arrival, cool];
		}

		data = data.map(function(d) {
			var a = accessor(d);
			d.number = a[0] / total_pop;
			var classes = 10;
			d.number = total_pop * Math.floor(classes*d.number)/classes;

			d.arrival = a[1] / total_pop;
			d.cool = a[2];
			return d;
		});

		var lin = d3.scale.linear()
			.domain([0, total_pop]) // d3.extent(data, function(d) {return d.number;})])
			.range([0,1]);

		labcolor = function(n, a) {
			if (opts.threshold == 4) a = 0.1;
			a = 0.1;
			return d3.lab(lin(n), 60 - a * 50, 40 + a * 90).toString();
		}
		
		labcolor2 = function(n,a) {
			if (opts.threshold == 4) a = 0.1;
			else a = a < 0.2 ? 0 : 0.8
			var c = d3.interpolateLab('#41f441','orange','#ffd86e');
			return d3.interpolateRgb('#111', c(a))(lin(n));
		}

		hslcolor = function(n, a) {
			if (opts.threshold == 4) a = 0.1;
			b = 0.2;
			return d3.hsl(128, a, 0.10 + lin(n)/2).toString();
		}

		lincolor = d3.scale.linear()
			.domain([0, total_pop]) // d3.extent(data, function(d) {return d.number;})])
			.range(range);

		color = labcolor2

		svg.selectAll(what)
		.style({
			fill: '#999',
		});
		
		svg.selectAll('#gdp, #population, #capitals').remove();
		svg.selectAll('#borders').style({
			stroke: 'white',
			'stroke-width': '0.2mm',
		});

		data
		.forEach(function(d) {
			var id = '.' + d.iso3;
			svg
			.select(what + id)
			.style({
				fill: color(d.number, d.arrival),
				'fill-opacity': 1,
			})
			.on('mouseover', function() {
				svg.select('#title text')
				.text('ok ' + id + ' ' + Math.floor(d.number / 1e6) + 'm');
			});
		});
	});
}
</script>



<embed id="svgObject" src="build/visionscarto-bertin1953.svg" type="image/svg+xml" onload="choropleth(this, {csv: '../doyouneedavisa/doyouneedavisa.csv', threshold: 3, what: 'country', order: 'asc', range:['black', '#00ffe2'], titre: ['Humains acceptés', 'sans visa préalable' ] });"></embed>


<embed id="svgObject" src="build/visionscarto-bertin1953.svg" type="image/svg+xml" onload="choropleth(this, {csv: '../doyouneedavisa/doyouneedavisa.csv', threshold: 4, what: 'country', order: 'asc', range:['black', '#ff55d8'], titre: ['Humains acceptés', 'sans visa' ] });"></embed>
